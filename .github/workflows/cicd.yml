name: Build, Test, and Update Development Environment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # Run every night at midnight UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          experimental-features = nix-command flakes 

    - name: Update Fedora base image digest (schedule/dispatch only)
      if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
      run: |
        set -euo pipefail

        # Determine the Nix system name for this architecture
        if [[ "${{ matrix.arch }}" == "amd64" ]]; then
          NIX_SYSTEM="x86_64-linux"
        else
          NIX_SYSTEM="aarch64-linux"
        fi

        # Pull latest Fedora and get its digest
        docker pull fedora:latest
        NEW_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' fedora:latest | cut -d'@' -f2)
        echo "Latest Fedora digest: $NEW_DIGEST"

        # Update the imageDigest in flake.nix
        sed -i "s|imageDigest = \"sha256:[^\"]*\"|imageDigest = \"$NEW_DIGEST\"|" flake.nix

        # Use a fake hash to trigger Nix to tell us the correct one
        FAKE_HASH="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
        sed -i "s|\"$NIX_SYSTEM\" = \"sha256-[^\"]*\"|\"$NIX_SYSTEM\" = \"$FAKE_HASH\"|" flake.nix

        # Build and capture the correct hash from the error
        set +e
        BUILD_OUTPUT=$(nix build .#containerImageFedora 2>&1)
        set -e

        # Extract the correct hash from the error message
        CORRECT_HASH=$(echo "$BUILD_OUTPUT" | grep -oP 'got:\s+\K\S+' | head -1)

        if [[ -z "$CORRECT_HASH" ]]; then
          echo "Failed to get correct hash from Nix build output"
          echo "$BUILD_OUTPUT"
          exit 1
        fi

        echo "Correct Nix hash for $NIX_SYSTEM: $CORRECT_HASH"

        # Update with the correct hash
        sed -i "s|\"$NIX_SYSTEM\" = \"$FAKE_HASH\"|\"$NIX_SYSTEM\" = \"$CORRECT_HASH\"|" flake.nix

        # Verify the build works
        nix build .#containerImageFedora

        # Save the hash and digest for later aggregation
        mkdir -p /tmp/fedora-hashes
        echo "$CORRECT_HASH" > "/tmp/fedora-hashes/$NIX_SYSTEM.hash"
        echo "$NEW_DIGEST" > "/tmp/fedora-hashes/digest"

    - name: Upload Fedora hash artifact
      if: ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      uses: actions/upload-artifact@v4
      with:
        name: fedora-hash-${{ matrix.arch }}
        path: /tmp/fedora-hashes/
        retention-days: 1

    - name: Update flake.lock (schedule/dispatch only)
      if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
      run: |
        nix flake update


    - name: Upload flake.lock artifact
      if: ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' && matrix.runner == 'ubuntu-latest' }}
      uses: actions/upload-artifact@v4
      with:
        name: flake-lock
        path: flake.lock
        retention-days: 1

    - name: Install Nix Profile
      run: |
        nix profile install .#default

    - name: Test nix develop environment
      run: |
        nix develop . -c bash -c "echo 'Nix develop test successful'"

    - name: Build Container image
      run: |
        docker build -t container-built-nix-dev-env .

    - name: Test Container image
      run: |
        docker run --rm container-built-nix-dev-env bash -c "echo 'Container test successful'"

    - name: Build Nix Container image
      run: |
        nix build .#containerImage
        docker load < result

    - name: Test Nix Container image
      run: |
        docker run --rm nix-dev-env bash -c "echo 'Container test successful'"

    - name: Build Nix Fedora Container image
      run: |
        nix build .#containerImageFedora
        docker load < result

    - name: Test Nix Fedora Container image
      run: |
        docker run --rm nix-dev-env-fedora bash -c "echo 'Fedora container test successful'"

    - name: Export Nix image tarball (for publish)
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      run: |
        set -euo pipefail
        # `result` is a symlink; copy the actual tarball so upload-artifact gets a real file.
        cp -L result "nix-image-${{ matrix.arch }}.tar"

    - name: Upload Nix image tarball artifact
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      uses: actions/upload-artifact@v4
      with:
        name: nix-image-${{ matrix.arch }}
        path: nix-image-${{ matrix.arch }}.tar
        retention-days: 1

    - name: Export VSCode image tarball (for publish)
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      run: |
        set -euo pipefail
        docker save container-built-nix-dev-env -o "vscode-image-${{ matrix.arch }}.tar"

    - name: Upload VSCode image tarball artifact
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      uses: actions/upload-artifact@v4
      with:
        name: vscode-image-${{ matrix.arch }}
        path: vscode-image-${{ matrix.arch }}.tar
        retention-days: 1

    - name: Export Fedora image tarball (for publish)
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      run: |
        set -euo pipefail
        docker save nix-dev-env-fedora -o "fedora-image-${{ matrix.arch }}.tar"

    - name: Upload Fedora image tarball artifact
      if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      uses: actions/upload-artifact@v4
      with:
        name: fedora-image-${{ matrix.arch }}
        path: fedora-image-${{ matrix.arch }}.tar
        retention-days: 1

  macos:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Update flake.lock (schedule/dispatch only)
      if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
      run: |
        nix flake update

    - name: Install Nix Profile
      run: |
        nix profile install .#default

    - name: Test nix develop environment
      run: |
        nix develop . -c bash -c "echo 'Nix develop test successful'"

  commit_flake_lock:
    name: Commit flake updates
    needs:
      - linux
      - macos
    if: ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download flake.lock artifact
      uses: actions/download-artifact@v4
      with:
        name: flake-lock
        path: /tmp/flake-lock

    - name: Download Fedora hash artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: fedora-hash-*
        path: /tmp/fedora-hashes
        merge-multiple: false
      continue-on-error: true

    - name: Apply updates to flake.nix and flake.lock
      run: |
        set -euo pipefail

        # Apply flake.lock update
        cp /tmp/flake-lock/flake.lock flake.lock

        # Apply Fedora hash updates from artifacts
        if [[ -d /tmp/fedora-hashes ]]; then
          # Get and apply the digest (same for both architectures)
          for dir in /tmp/fedora-hashes/fedora-hash-*/; do
            if [[ -f "${dir}digest" ]]; then
              NEW_DIGEST=$(cat "${dir}digest")
              echo "Updating imageDigest to $NEW_DIGEST"
              sed -i "s|imageDigest = \"sha256:[^\"]*\"|imageDigest = \"$NEW_DIGEST\"|" flake.nix
              break
            fi
          done

          # Update x86_64-linux hash
          if [[ -f /tmp/fedora-hashes/fedora-hash-amd64/x86_64-linux.hash ]]; then
            NEW_HASH=$(cat /tmp/fedora-hashes/fedora-hash-amd64/x86_64-linux.hash)
            echo "Updating x86_64-linux hash to $NEW_HASH"
            sed -i "s|\"x86_64-linux\" = \"sha256-[^\"]*\"|\"x86_64-linux\" = \"$NEW_HASH\"|" flake.nix
          fi

          # Update aarch64-linux hash
          if [[ -f /tmp/fedora-hashes/fedora-hash-arm64/aarch64-linux.hash ]]; then
            NEW_HASH=$(cat /tmp/fedora-hashes/fedora-hash-arm64/aarch64-linux.hash)
            echo "Updating aarch64-linux hash to $NEW_HASH"
            sed -i "s|\"aarch64-linux\" = \"sha256-[^\"]*\"|\"aarch64-linux\" = \"$NEW_HASH\"|" flake.nix
          fi
        fi

    - name: Commit and push updates
      run: |
        set -euo pipefail
        if git diff --quiet flake.lock; then
          echo "No flake.lock changes to commit."
          exit 0
        fi
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add flake.lock
        git commit -m "Update flake.lock"
        git push origin HEAD:${{ github.ref_name }}

  publish_nix_images:
    name: Publish Nix images (${{ matrix.arch }})
    needs: linux
    if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ${{ matrix.runner }}
    environment: dockerhub
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
    - name: Download Nix image tarball
      uses: actions/download-artifact@v4
      with:
        name: nix-image-${{ matrix.arch }}
        path: /tmp/nix-image

    - name: Load Nix image
      run: |
        set -euo pipefail
        docker load < "/tmp/nix-image/nix-image-${{ matrix.arch }}.tar"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag and push arch-specific images
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        ARCH="${{ matrix.arch }}"

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        VERSION_TAG="sha-${GITHUB_SHA}"

        docker tag nix-dev-env:latest "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"
        docker push "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"

        docker tag nix-dev-env:latest "$IMAGE_NAME:latest-${ARCH}"
        docker push "$IMAGE_NAME:latest-${ARCH}"

  push_nix_manifest:
    name: Push multi-arch manifest
    needs: publish_nix_images
    if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ubuntu-latest
    environment: dockerhub
    permissions:
      contents: read

    steps:
    - name: Compute image name and tag
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
          VERSION_TAG="${GITHUB_REF_NAME}"
        else
          VERSION_TAG="sha-${GITHUB_SHA}"
        fi

        echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
        echo "VERSION_TAG=$VERSION_TAG" >> "$GITHUB_ENV"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        set -euo pipefail

        docker buildx imagetools create \
          -t "$IMAGE_NAME:${VERSION_TAG}" \
          "$IMAGE_NAME:${VERSION_TAG}-amd64" \
          "$IMAGE_NAME:${VERSION_TAG}-arm64"

        docker buildx imagetools create \
          -t "$IMAGE_NAME:latest" \
          "$IMAGE_NAME:latest-amd64" \
          "$IMAGE_NAME:latest-arm64"

  publish_fedora_images:
    name: Publish Fedora images (${{ matrix.arch }})
    needs: linux
    if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ${{ matrix.runner }}
    environment: dockerhub
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
    - name: Download Fedora image tarball
      uses: actions/download-artifact@v4
      with:
        name: fedora-image-${{ matrix.arch }}
        path: /tmp/fedora-image

    - name: Load Fedora image
      run: |
        set -euo pipefail
        docker load < "/tmp/fedora-image/fedora-image-${{ matrix.arch }}.tar"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag and push arch-specific images
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        ARCH="${{ matrix.arch }}"

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        VERSION_TAG="fedora-sha-${GITHUB_SHA}"

        docker tag nix-dev-env-fedora:latest "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"
        docker push "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"

        docker tag nix-dev-env-fedora:latest "$IMAGE_NAME:fedora-latest-${ARCH}"
        docker push "$IMAGE_NAME:fedora-latest-${ARCH}"

  push_fedora_manifest:
    name: Push Fedora multi-arch manifest
    needs: publish_fedora_images
    if: ${{ github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ubuntu-latest
    environment: dockerhub
    permissions:
      contents: read

    steps:
    - name: Compute image name and tag
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        VERSION_TAG="fedora-sha-${GITHUB_SHA}"

        echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
        echo "VERSION_TAG=$VERSION_TAG" >> "$GITHUB_ENV"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        set -euo pipefail

        docker buildx imagetools create \
          -t "$IMAGE_NAME:${VERSION_TAG}" \
          "$IMAGE_NAME:${VERSION_TAG}-amd64" \
          "$IMAGE_NAME:${VERSION_TAG}-arm64"

        docker buildx imagetools create \
          -t "$IMAGE_NAME:fedora-latest" \
          "$IMAGE_NAME:fedora-latest-amd64" \
          "$IMAGE_NAME:fedora-latest-arm64"