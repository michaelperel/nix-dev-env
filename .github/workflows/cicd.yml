name: Build, Test, and Update Development Environment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # Run every night at midnight UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux:
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Update flake.lock (schedule/dispatch only)
      if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
      run: |
        nix flake update

    - name: Upload flake.lock artifact
      if: ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' && matrix.runner == 'ubuntu-latest' }}
      uses: actions/upload-artifact@v4
      with:
        name: flake-lock
        path: flake.lock
        retention-days: 1

    - name: Install Nix Profile
      run: |
        nix profile install .#default

    - name: Test nix develop environment
      run: |
        nix develop . -c bash -c "echo 'Nix develop test successful'"

    - name: Build Container image
      run: |
        docker build -t container-built-nix-dev-env .

    - name: Test Container image
      run: |
        docker run --rm container-built-nix-dev-env bash -c "echo 'Container test successful'"

    - name: Build Nix Container image
      run: |
        nix build .#containerImage
        docker load < result

    - name: Test Nix Container image
      run: |
        docker run --rm nix-dev-env bash -c "echo 'Container test successful'"

    - name: Export Nix image tarball (for publish)
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      run: |
        set -euo pipefail
        # `result` is a symlink; copy the actual tarball so upload-artifact gets a real file.
        cp -L result "nix-image-${{ matrix.arch }}.tar"

    - name: Upload Nix image tarball artifact
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
      uses: actions/upload-artifact@v4
      with:
        name: nix-image-${{ matrix.arch }}
        path: nix-image-${{ matrix.arch }}.tar
        retention-days: 1 

  macos:
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]') }}
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          experimental-features = nix-command flakes

    - name: Update flake.lock (schedule/dispatch only)
      if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
      run: |
        nix flake update

    - name: Install Nix Profile
      run: |
        nix profile install .#default

    - name: Test nix develop environment
      run: |
        nix develop . -c bash -c "echo 'Nix develop test successful'"

  commit_flake_lock:
    name: Commit flake.lock update
    needs:
      - linux
      - macos
    if: ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download flake.lock artifact
      uses: actions/download-artifact@v4
      with:
        name: flake-lock
        path: /tmp/flake-lock

    - name: Apply updated flake.lock
      run: |
        set -euo pipefail
        cp /tmp/flake-lock/flake.lock flake.lock

    - name: Commit and push flake.lock
      run: |
        set -euo pipefail
        if git diff --quiet flake.lock; then
          echo "No flake.lock changes to commit."
          exit 0
        fi
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add flake.lock
        git commit -m "Update flake.lock [skip ci]"
        git push origin HEAD:${{ github.ref_name }}

  publish_nix_images:
    name: Publish Nix images (${{ matrix.arch }})
    needs: linux
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ${{ matrix.runner }}
    environment: dockerhub
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
    - name: Download Nix image tarball
      uses: actions/download-artifact@v4
      with:
        name: nix-image-${{ matrix.arch }}
        path: /tmp/nix-image

    - name: Load Nix image
      run: |
        set -euo pipefail
        docker load < "/tmp/nix-image/nix-image-${{ matrix.arch }}.tar"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag and push arch-specific images
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        ARCH="${{ matrix.arch }}"

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        VERSION_TAG="sha-${GITHUB_SHA}"

        docker tag nix-dev-env:latest "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"
        docker push "$IMAGE_NAME:${VERSION_TAG}-${ARCH}"

        docker tag nix-dev-env:latest "$IMAGE_NAME:latest-${ARCH}"
        docker push "$IMAGE_NAME:latest-${ARCH}"

  push_nix_manifest:
    name: Push multi-arch manifest
    needs: publish_nix_images
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'michaelperel/nix-dev-env' }}
    runs-on: ubuntu-latest
    environment: dockerhub
    permissions:
      contents: read

    steps:
    - name: Compute image name and tag
      env:
        DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        set -euo pipefail

        if [[ -n "${DOCKERHUB_REPO:-}" ]]; then
          IMAGE_NAME="$DOCKERHUB_REPO"
        else
          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "DOCKERHUB_USERNAME or DOCKERHUB_REPO must be set as a secret." >&2
            exit 1
          fi
          IMAGE_NAME="$DOCKERHUB_USERNAME/nix-dev-env"
        fi

        if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
          VERSION_TAG="${GITHUB_REF_NAME}"
        else
          VERSION_TAG="sha-${GITHUB_SHA}"
        fi

        echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
        echo "VERSION_TAG=$VERSION_TAG" >> "$GITHUB_ENV"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        set -euo pipefail

        docker buildx imagetools create \
          -t "$IMAGE_NAME:${VERSION_TAG}" \
          "$IMAGE_NAME:${VERSION_TAG}-amd64" \
          "$IMAGE_NAME:${VERSION_TAG}-arm64"

        docker buildx imagetools create \
          -t "$IMAGE_NAME:latest" \
          "$IMAGE_NAME:latest-amd64" \
          "$IMAGE_NAME:latest-arm64"